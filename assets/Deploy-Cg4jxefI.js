import{W as O}from"./UtilityNavbar-Cz61971B.js";import E from"./TemplateDefault-BxX7Fqyz.js";import{S as L}from"./SectionHero-BliQJIvN.js";import{T as W,u as H,a as M}from"./unzipit.module-CFtoeuyV.js";import{_ as Z,c as K,w as b,r as w,o as r,a as R,b as o,t as p,g as l,k as u,d,e as c,v as m,h as f,F as y,f as k,j as Y,p as G,l as J}from"./index-BGG5645e.js";const Q={components:{WrapperPage:O,TemplateDefault:E,SectionHero:L},props:["renderer"],inject:["io"],data:()=>({dockerComposeFile:"",files:[],name:"",slug:"",repository:"",branch:"",branches:[],adjustVolumes:!0,inherit:!0,running:!1,webhook:!1,searchRepos:!1,oauthProviders:[],consentUrl:"",search:"",user:null,query:"",organisations:[],repositories:null,log:null,loading:""}),watch:{async searchRepos(e){e&&(await this.getOAuthProviders(),await this.getUser(),await this.getOrganisations(),!this.query&&this.orgs.length&&(this.query=this.orgs[0].query,await this.getRepositories()))},async query(){await this.getRepositories()},async repository(e){var i;const t=(i=this.repositories)==null?void 0:i.items.find(n=>n.clone_url===e);t&&(this.branch=t.default_branch,await this.getBranches(t),await this.getDockerCompose(t))},async branch(e){var i;const t=(i=this.repositories)==null?void 0:i.items.find(n=>n.clone_url===this.repository);t&&await this.getDockerCompose(t)}},computed:{id(){return this.$route.params.id||this.slug},oauthProvidersFiltered(){const e=["github"];return this.oauthProviders.filter(t=>e.includes(t.provider))},orgs(){var e,t;return[{title:(e=this.user)==null?void 0:e.login,query:`user:${(t=this.user)==null?void 0:t.login}`},...this.organisations.map(i=>{var n,h;return{title:(n=i==null?void 0:i.organization)==null?void 0:n.login,query:`org:${(h=i==null?void 0:i.organization)==null?void 0:h.login}`}})]}},async created(){await this.getOAuthProviders(),this.id&&await this.getItem()},methods:{async getDockerCompose(e){this.loading="docker compose file";const t=this.oauthProvidersFiltered.find(i=>i.provider==="github");if(t)try{const n=await(await fetch(e.contents_url.replace("{+path}","docker-compose.yml")+`?ref=${this.branch}`,{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${t.token}`}})).json();n.download_url&&(this.dockerComposeFile=await(await fetch(n.download_url)).text())}catch{console.error("Could not fetch docker-compose.yml",error)}this.loading=""},async getUser(){this.loading="user";const e=this.oauthProvidersFiltered.find(t=>t.provider==="github");if(e){let t=await fetch("https://api.github.com/user",{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${e.token}`}});this.user=await t.json(),console.log("user",this.user)}this.loading=""},async getOrganisations(){this.loading="organisations";const e=this.oauthProvidersFiltered.find(t=>t.provider==="github");if(e){let t=await fetch("https://api.github.com/user/memberships/orgs?per_page=150",{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${e.token}`}});this.organisations=await t.json(),console.log("orgs",this.organisations)}this.loading=""},async getRepositories(){this.loading="repositories";const e=this.oauthProvidersFiltered.find(t=>t.provider==="github");if(e){let t="q="+encodeURIComponent(this.search+(" "+this.query||" user:"+this.user.login)),i=await fetch(`https://api.github.com/search/repositories?${t}&per_page=150`,{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${e.token}`}});this.repositories=await i.json(),console.log("repos",this.repositories)}this.loading=""},async getBranches(e){this.loading="branches";const t=this.oauthProvidersFiltered.find(i=>i.provider==="github");if(t){let i=await fetch(e.branches_url.replace("{/branch}","")+"?per_page=150",{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${t.token}`}});this.branches=await i.json(),console.log("branches",this.branches)}this.loading=""},consent(e){e&&window.open(e,"_blank")},async getOAuthProviders(){this.loading="providers";const e=await this.io.service("oauth_providers").find({query:{}});this.oauthProviders=e==null?void 0:e.data,this.loading=""},async getItem(){this.loading="app";const e=await this.io.service("apps").get(this.id);this.name=e.name,this.slug=e.id,this.repository=e.repository,this.branch=e.branch,this.adjustVolumes=e.adjustVolumes,this.inherit=e.inherit,this.running=e.running,this.dockerComposeFile=e.dockerComposeFile,this.webhook=e.webhook,this.log=e.log,console.log(e),this.loading=""},async remove(){this.loading="remove app";try{const e=await this.io.service("apps").remove(this.id);console.log("res",e),this.$router.push("/apps")}catch(e){console.log("err",e)}this.loading=""},async attach(){this.loading="attach webhook";try{const e=await this.io.service("apps").patch(this.id,{attach:!0});console.log("res",e)}catch(e){console.log("err",e)}await this.getItem(),this.loading=""},async detach(){this.loading="detach webhook";try{const e=await this.io.service("apps").patch(this.id,{detach:!0});console.log("res",e)}catch(e){console.log("err",e)}await this.getItem(),this.loading=""},async start(){this.loading="start app";try{const e=await this.io.service("apps").patch(this.id,{start:!0});console.log("res",e)}catch(e){console.log("err",e)}await this.getItem(),this.loading=""},async stop(){this.loading="stop app";try{const e=await this.io.service("apps").patch(this.id,{stop:!0});console.log("res",e)}catch(e){console.log("err",e)}await this.getItem(),this.loading=""},async build(){this.loading="build app";try{const e=await this.io.service("apps").patch(this.id,{build:!0});console.log("res",e)}catch(e){console.log("err",e)}await this.getItem(),this.loading=""},async destroy(){this.loading="destroy app";try{const e=await this.io.service("apps").patch(this.id,{destroy:!0});console.log("res",e)}catch(e){console.log("err",e)}await this.getItem(),this.loading=""},async compose(){this.loading="compose app";const e=await this.io.service("apps").patch(this.id,{compose:this.dockerComposeFile});console.log("res",e),await this.getItem(),this.loading=""},async deploy(){var e;this.loading="deploy app";try{console.log("files",this.files);const t=await this.io.service("apps").create({name:this.name,slug:this.id,buffer:(e=this.files)!=null&&e.length?await this.packTar():null,repository:this.repository,branch:this.branch,dockerComposeFile:this.dockerComposeFile,adjustVolumes:this.adjustVolumes,inherit:this.inherit});console.log("res",t)}catch(t){console.log("error",t)}await this.getItem(),this.loading=""},async update(){var e;this.loading="update app";try{const t=await this.io.service("apps").update(this.id,{buffer:(e=this.files)!=null&&e.length?await this.packTar():null,repository:this.repository,dockerComposeFile:this.dockerComposeFile,inherit:this.inherit,adjustVolumes:this.adjustVolumes,branch:this.branch,name:this.name});console.log("res",t)}catch(t){console.log("error",t)}await this.getItem(),this.loading=""},async resolveDockerCompose(){this.loading="docker compose file";const e=this.files.find(t=>t.name.endsWith("docker-compose.yml"));if(e){const t=new TextDecoder().decode(e.buffer);this.dockerComposeFile=t}this.loading=""},async packTar(){let e=new W;for await(let t of this.files)e.append(t.name,new Uint8Array(t.buffer));return e.out},async uploadZip(){return this.files=[],this.dockerComposeFile="",new Promise(e=>{let t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=".zip",t.onchange=async()=>{let i=Array.from(t.files)[0];const{entries:n}=await H(await i.arrayBuffer());for await(const[h,a]of Object.entries(n))n[h].isDirectory||this.files.push({buffer:await a.arrayBuffer(),name:h});await this.resolveDockerCompose(),e()},t.click()})},async uploadTar(){return this.files=[],this.dockerComposeFile="",new Promise(e=>{let t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=".tar",t.onchange=async()=>{let i=Array.from(t.files)[0],n=await M(await i.arrayBuffer());for await(let h of n)this.files.push({buffer:h.buffer,name:h.name});await this.resolveDockerCompose(),e()},t.click()})},async uploadFolder(){return this.files=[],this.dockerComposeFile="",new Promise(e=>{let t=document.createElement("input");t.type="file",t.multiple=!0,t.webkitdirectory=!0,t.dir=!0,t.onchange=async()=>{let i=Array.from(t.files);for await(let n of i)this.files.push({buffer:await n.arrayBuffer(),name:n.webkitRelativePath});await this.resolveDockerCompose(),e()},t.click()})},async uploadFiles(){return this.files=[],this.dockerComposeFile="",new Promise(e=>{let t=document.createElement("input");t.type="file",t.multiple=!0,t.onchange=async()=>{let i=Array.from(t.files);for await(let n of i){let h=await n.arrayBuffer();this.files.push({buffer:h,name:"root/"+n.name})}await this.resolveDockerCompose(),e()},t.click()})}}},g=e=>(G("data-v-b6e15ba9"),e=e(),J(),e),X={class:"w-full"},_={class:"font-thin text-xl lg:text-3xl xl:pl-6 w-full text-center uppercase"},x={key:0,class:"font-thin block xl:pl-6 w-full text-center uppercase"},ee={class:"mt-8 mb-20 relative overflow-auto w-full"},te={key:0,class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},se={class:"block my-2"},oe={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},ie=g(()=>o("label",{class:"block my-2"}," Basic app settings ",-1)),ae={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},re=g(()=>o("label",{class:"block my-2"}," Upload using drop of Tar / Zip / Folder / Docker Compose File / Docker File ",-1)),le={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},ne={class:"block my-2"},de={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},pe=g(()=>o("label",{class:"block my-2"}," Clone using a git provider ",-1)),ue={class:"mr-4 inline-block"},he=["onClick"],ce={key:0},me={class:"block my-2"},ge=["value"],fe={class:"block my-2"},ye=["value"],be={class:"block my-2"},we=["value"],ke=g(()=>o("label",{class:"block my-2"}," Repository ",-1)),ve=g(()=>o("label",{class:"block my-2"}," Branch ",-1)),Ce=g(()=>o("div",{class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},[o("label",{class:"block my-2"}," One click installation browsing images from docker hub ")],-1)),Fe={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},je=g(()=>o("label",{class:"block my-2"},"Docker Compose",-1)),De={class:"text-right"},Ve=["disabled"];function $e(e,t,i,n,h,a){const T=w("SectionHero"),q=w("WrapperPage"),z=w("TemplateDefault");return r(),K(z,{renderer:i.renderer},{default:b(()=>[R(T,null,{default:b(()=>[o("div",X,[o("h1",_,p(a.id||"Deploy Docker App"),1),e.loading?(r(),l("h2",x," Loading - "+p(e.loading)+" ... ",1)):u("",!0)])]),_:1}),R(q,{class:"p-6"},{default:b(()=>{var v,C,F,j,D,V,$,P,U,A,B,S,I;return[o("div",ee,[o("div",null,[o("button",{class:"py-4 p-2 w-full rounded bg-slate-200",onClick:t[0]||(t[0]=s=>a.getItem())}," Reload ")]),e.log?(r(),l("div",te,[o("label",se," Last updated "+p(new Date(((j=(F=(C=(v=e.log)==null?void 0:v[0])==null?void 0:C.commit)==null?void 0:F.author)==null?void 0:j.timestamp)*1e3).toLocaleString())+" by "+p((P=($=(V=(D=e.log)==null?void 0:D[0])==null?void 0:V.commit)==null?void 0:$.author)==null?void 0:P.name),1)])):u("",!0),o("div",oe,[ie,d(),c(o("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>e.name=s),placeholder:"Name",class:"px-4 py-2 block w-full mb-4"},null,512),[[m,e.name]]),e.$route.params.id?u("",!0):c((r(),l("input",{key:0,"onUpdate:modelValue":t[2]||(t[2]=s=>e.slug=s),placeholder:"Slug",class:"px-4 py-2 block w-full"},null,512)),[[m,e.slug]]),d(),e.$route.params.id?c((r(),l("input",{key:1,"onUpdate:modelValue":t[3]||(t[3]=s=>a.id=s),placeholder:"Slug",readonly:"",class:"px-4 py-2 block w-full"},null,512)),[[m,a.id]]):u("",!0)]),o("div",ae,[re,o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:t[4]||(t[4]=s=>a.uploadFiles())}," Upload files "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:t[5]||(t[5]=s=>e.uploadFolde())}," Upload folder "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:t[6]||(t[6]=s=>a.uploadTar())}," Upload tar "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:t[7]||(t[7]=s=>a.uploadZip())}," Upload zip ")]),o("div",le,[o("label",ne," Files count: "+p(e.files.length),1)]),o("div",de,[pe,(r(!0),l(y,null,f(a.oauthProvidersFiltered,s=>(r(),l("div",ue,[o("button",{class:"rounded p-2 bg-slate-200 mr-1",onClick:N=>a.consent(s.consent_url)}," Connect to "+p(s.provider),9,he),d(),o("button",{class:"rounded p-2 bg-slate-200",onClick:t[8]||(t[8]=N=>e.searchRepos=!e.searchRepos)},p(e.searchRepos?"Close":"Select repository"),1)]))),256)),e.searchRepos?(r(),l("div",ce,[o("label",me," Select user / organisation ("+p(((U=a.orgs)==null?void 0:U.length)||"0")+") ",1),d(),c(o("select",{"onUpdate:modelValue":t[9]||(t[9]=s=>e.query=s),class:"mt-2 px-4 py-2 w-full"},[(r(!0),l(y,null,f(a.orgs,s=>(r(),l("option",{value:s.query},p(s.title),9,ge))),256))],512),[[k,e.query]]),d(),c(o("input",{"onUpdate:modelValue":t[10]||(t[10]=s=>e.search=s),placeholder:"Search for repository ...",class:"mt-2 px-4 py-2 w-full",onKeypress:t[11]||(t[11]=Y(s=>a.getRepositories(),["enter"]))},null,544),[[m,e.search]]),d(),o("button",{class:"rounded p-2 mt-2 w-full bg-slate-200",onClick:t[12]||(t[12]=s=>a.getRepositories())}," Search "),d(),o("label",fe," Select Repository ("+p(((B=(A=e.repositories)==null?void 0:A.items)==null?void 0:B.length)||"0")+") ",1),d(),c(o("select",{"onUpdate:modelValue":t[13]||(t[13]=s=>e.repository=s),class:"mt-2 px-4 py-2 w-full"},[(r(!0),l(y,null,f((S=e.repositories)==null?void 0:S.items,s=>(r(),l("option",{value:s.clone_url},p(s.full_name),9,ye))),256))],512),[[k,e.repository]]),d(),o("label",be," Select Branch ("+p(((I=e.branches)==null?void 0:I.length)||"0")+") ",1),d(),c(o("select",{"onUpdate:modelValue":t[14]||(t[14]=s=>e.branch=s),class:"mt-2 px-4 py-2 w-full"},[(r(!0),l(y,null,f(e.branches,s=>(r(),l("option",{value:s.name},p(s.name),9,we))),256))],512),[[k,e.branch]])])):u("",!0),d(),ke,d(),c(o("input",{"onUpdate:modelValue":t[15]||(t[15]=s=>e.repository=s),placeholder:"Repository url",class:"mt-2 px-4 py-2 w-full"},null,512),[[m,e.repository]]),d(),ve,d(),c(o("input",{"onUpdate:modelValue":t[16]||(t[16]=s=>e.branch=s),placeholder:"Branch",class:"mt-2 px-4 py-2 w-full"},null,512),[[m,e.branch]]),d(),o("button",{class:"rounded p-2 bg-slate-200 mt-2",onClick:t[17]||(t[17]=s=>e.adjustVolumes=!e.adjustVolumes)}," Move volumes to app folder: "+p(e.adjustVolumes?"Yes":"No"),1)]),Ce,o("div",Fe,[je,o("button",{class:"rounded p-2 bg-slate-200 my-4",onClick:t[18]||(t[18]=s=>e.inherit=!e.inherit)}," Inherit original docker-compose file: "+p(e.inherit?"Yes":"No"),1),d(),c(o("textarea",{class:"w-full p-4","onUpdate:modelValue":t[19]||(t[19]=s=>e.dockerComposeFile=s),rows:"10",placeholder:"docker-compose.override.yml"},null,512),[[m,e.dockerComposeFile]])]),o("div",De,[e.$route.params.id?u("",!0):(r(),l("button",{key:0,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",disabled:!e.slug,onClick:t[20]||(t[20]=s=>a.deploy())}," Launch ",8,Ve)),e.$route.params.id?(r(),l("button",{key:1,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[21]||(t[21]=s=>a.update())}," Update ")):u("",!0),!e.webhook&&e.$route.params.id&&e.repository?(r(),l("button",{key:2,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[22]||(t[22]=s=>a.attach())}," Attach webhook ")):u("",!0),e.webhook&&e.$route.params.id&&e.repository?(r(),l("button",{key:3,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[23]||(t[23]=s=>a.detach())}," Detach webhook ")):u("",!0),!e.running&&e.$route.params.id?(r(),l("button",{key:4,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[24]||(t[24]=s=>a.start())}," Start ")):u("",!0),d(),e.running&&e.$route.params.id?(r(),l("button",{key:5,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[25]||(t[25]=s=>a.stop())}," Stop ")):u("",!0),d(),e.$route.params.id?(r(),l("button",{key:6,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[26]||(t[26]=s=>a.build())}," Build ")):u("",!0),d(),e.$route.params.id?(r(),l("button",{key:7,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[27]||(t[27]=s=>a.destroy())}," Destroy ")):u("",!0),d(),e.$route.params.id?(r(),l("button",{key:8,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[28]||(t[28]=s=>a.compose())}," Compose ")):u("",!0),d(),e.$route.params.id?(r(),l("button",{key:9,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:t[29]||(t[29]=s=>a.remove())}," Remove ")):u("",!0)])])]}),_:1})]),_:1},8,["renderer"])}const Ie=Z(Q,[["render",$e],["__scopeId","data-v-b6e15ba9"]]);export{Ie as default};
